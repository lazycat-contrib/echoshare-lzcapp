import{d as j,u as z,a as Q,w as _,c as L,F as O,b as G,e as h,f as b,g as W,v as J,t as K,r as V,h as s,i as y,o as p,j as v,k as H,l as te,m as q,n as ie,p as ue,T as de,q as re,s as P,x as ne,y as S,z as T,A as M,B as ce,C as F,D as me}from"./index.DoEgvpef.js";import{s as ve,d as R,a as pe,c as fe}from"./index.DRcMaQWl.js";import{u as he,c as be,a as Me}from"./useAutoPlay.CCLiOSYS.js";import{u as we}from"./history.CmTeTBOX.js";import{u as Ve}from"./webhook.2Jsr7by1.js";const ye={class:"mt-6 sm:mt-4 max-sm:mb-4 flex flex-wrap w-full xl:w-1/2"},ke={class:"basis-1/2 sm:basis-1/4 grow"},Ce={class:"basis-1/2 sm:basis-1/4 grow"},De={class:"basis-1/2 sm:basis-1/4 grow max-sm:mt-4"},Ie={class:"basis-1/2 sm:basis-1/4 grow max-sm:mt-4"},Se=j({__name:"mediaConfig",props:{showTitle:{type:Boolean,default:!0}},emits:["changeMediaMode"],setup(Y,{emit:d}){var n,c;const{t:r,locale:g}=z(),e=Q(),U=d,x=Y,k=()=>[{value:0,text:r("mediaModeOptions.0"),useScreen:!0,useCamera:!1,useAudio:!0,useMircophone:!0},{value:1,text:r("mediaModeOptions.1"),useScreen:!0,useCamera:!1,useAudio:!1,useMircophone:!0},{value:2,text:r("mediaModeOptions.2"),useScreen:!0,useCamera:!1,useAudio:!0,useMircophone:!1},{value:3,text:r("mediaModeOptions.3"),useScreen:!0,useCamera:!1,useAudio:!1,useMircophone:!1},{value:4,text:r("mediaModeOptions.4"),useCamera:!0,useMircophone:!0,useScreen:!1,useAudio:!0},{value:5,text:r("mediaModeOptions.5"),useCamera:!0,useMircophone:!0,useScreen:!1,useAudio:!1},{value:6,text:r("mediaModeOptions.6"),useCamera:!0,useMircophone:!1,useScreen:!1,useAudio:!0},{value:7,text:r("mediaModeOptions.7"),useCamera:!0,useMircophone:!1,useScreen:!1,useAudio:!1}];_([()=>e.mediaMode.useScreen,()=>e.mediaMode.useCamera],([a,o],[m,f])=>{if(m!==a){e.mediaMode.useCamera=!a;return}if(f!==o){e.mediaMode.useScreen=!o;return}});function C(){return k().find(a=>a.useAudio===e.mediaMode.useAudio&&a.useCamera===e.mediaMode.useCamera&&a.useMircophone===e.mediaMode.useMircophone&&a.useScreen===e.mediaMode.useScreen)}return e.mediaMode.text=((n=C())==null?void 0:n.text)??"",e.mediaMode.value=((c=C())==null?void 0:c.value)??0,_([e.mediaMode,()=>e.audioDeviceId,()=>e.videoDeviceId,()=>e.audioutDeviceId,()=>g.value],()=>{var a,o;e.mediaMode.text=((a=C())==null?void 0:a.text)??"",e.mediaMode.value=((o=C())==null?void 0:o.value)??0,U("changeMediaMode")}),(a,o)=>{const m=V("VaCheckbox"),f=V("VaSelect");return p(),L(O,null,[G(h("h1",{class:"mt-6"},K(a.$t("media.title")),513),[[J,x.showTitle]]),h("div",ye,[h("div",ke,[b(m,{modelValue:s(e).mediaMode.useScreen,"onUpdate:modelValue":o[0]||(o[0]=l=>s(e).mediaMode.useScreen=l),label:a.$t("media.screen")},null,8,["modelValue","label"])]),h("div",Ce,[b(m,{modelValue:s(e).mediaMode.useCamera,"onUpdate:modelValue":o[1]||(o[1]=l=>s(e).mediaMode.useCamera=l),label:a.$t("media.camera")},null,8,["modelValue","label"])]),h("div",De,[b(m,{modelValue:s(e).mediaMode.useAudio,"onUpdate:modelValue":o[2]||(o[2]=l=>s(e).mediaMode.useAudio=l),label:a.$t("media.audio")},null,8,["modelValue","label"])]),h("div",Ie,[b(m,{modelValue:s(e).mediaMode.useMircophone,"onUpdate:modelValue":o[3]||(o[3]=l=>s(e).mediaMode.useMircophone=l),label:a.$t("media.microphone")},null,8,["modelValue","label"])])]),b(f,{"text-by":"text",modelValue:s(e).mediaMode,"onUpdate:modelValue":o[4]||(o[4]=l=>s(e).mediaMode=l),class:"w-full mt-4",label:a.$t("media.mediaModeLabel"),options:k(),placeholder:a.$t("media.mediaModePlaceholder")},null,8,["modelValue","label","options","placeholder"]),s(e).mediaMode.useCamera?(p(),L(O,{key:0},[s(e).videoDevices.length?(p(),y(f,{key:0,"text-by":"label",modelValue:s(e).videoDeviceId,"onUpdate:modelValue":o[5]||(o[5]=l=>s(e).videoDeviceId=l),"value-by":"deviceId",class:"w-full mt-4",label:a.$t("media.videoDeviceIdLabel"),options:s(e).videoDevices,placeholder:a.$t("media.videoDeviceIdPlaceholder"),requiredMark:""},null,8,["modelValue","label","options","placeholder"])):(p(),y(f,{key:1,"text-by":"label",modelValue:s(e).videoDeviceId,"onUpdate:modelValue":o[6]||(o[6]=l=>s(e).videoDeviceId=l),"value-by":"deviceId",class:"w-full mt-4",label:a.$t("media.videoDeviceIdLabel"),options:s(e).videoDevices,placeholder:a.$t("media.novideoDeviceIdLabel"),requiredMark:""},null,8,["modelValue","label","options","placeholder"]))],64)):W("",!0),s(e).mediaMode.useMircophone?(p(),L(O,{key:1},[s(e).audioDevices.length?(p(),y(f,{key:0,"text-by":"label",modelValue:s(e).audioDeviceId,"onUpdate:modelValue":o[7]||(o[7]=l=>s(e).audioDeviceId=l),"value-by":"deviceId",class:"w-full mt-4",label:a.$t("media.audioDeviceIdLabel"),options:s(e).audioDevices,placeholder:a.$t("media.audioDeviceIdPlaceholder"),requiredMark:""},null,8,["modelValue","label","options","placeholder"])):(p(),y(f,{key:1,"text-by":"label",modelValue:s(e).audioDeviceId,"onUpdate:modelValue":o[8]||(o[8]=l=>s(e).audioDeviceId=l),"value-by":"deviceId",class:"w-full mt-4",label:a.$t("media.audioDeviceIdLabel"),options:s(e).audioDevices,placeholder:a.$t("media.noAudioDeviceIdLabel"),requiredMark:""},null,8,["modelValue","label","options","placeholder"]))],64)):W("",!0)],64)}}}),ge={class:"mt-4"},Ue={class:"flex items-end"},xe={class:"flex grow-0 flex-row justify-end max-sm:ml-4 sm:ml-2"},$e={class:"relative"},Oe=j({__name:"screen",setup(Y){const{t:d}=z();let r=v(null),g=v(null),e=v(null);const U=te(),x=re(),k=Ve(),C=we(),n=v({uid:"",time:"",timestamp:new Date().getTime(),result:"fail",action:"share"}),c=v(H(U.query.uid)||""),a=Q(),o=v(""),m=v(!1),f=v(!1),l=v(!1),D=v(null),$=v(null),A=v({});function B(){$.value!==null&&clearInterval($.value),$.value=null}_(()=>c.value,(t,u)=>{x.push({query:{uid:t}}),u&&w()}),_(()=>U.query.uid,(t,u)=>{const i=H(t);c.value!==i&&(c.value=i)});function w(t=!1){m.value=!1,(r.value||t)&&(P.warning("Peer instance will be cleaned",o.value),be(r,e,g))}he(D,"Sender");function E(t,u=!0){if(!t.active){S(["share media check:","stream is not active"]),B(),w();return}u&&(S(["share media check:","stream is active"]),o.value=c.value||t.id,r.value=Me(o.value),r.value.on("error",i=>{M("⚠️ "+String(i)),w()}),r.value.on("call",i=>{i.answer(t),e.value=i,P.info("Acceptad requests",i.peer),F(d("toast.findConnect")+" "+i.peer)}),r.value.on("connection",i=>{setInterval(()=>{i.send(d("toast.senderheartbeatcheck")+"@"+o.value+": "+R().format("YYYY-MM-DD HH:mm:ss"))},2e3),i.on("data",I=>{typeof I=="string"&&I.startsWith("[TOAST_IN_CONSOLE]")?S(["toast-in-console",I.slice(18)]):F(d("toast.findMsg")+"@"+i.peer+": "+I),A.value[i.peer]&&(clearTimeout(A.value[i.peer]),A.value[i.peer]=null),A.value[i.peer]=setTimeout(()=>{me(d("toast.loseConnect")+" "+i.peer)},4e3)})}))}async function X(){var t;if(ve()){w(),B();try{m.value=!1,f.value=!0;const u=await ne();g.value=u,P.success("Media stream created",u.id),S(["Please check the media information",u]),E(u,!0),$.value=setInterval(()=>{E(u,!1)},2e3),P.success("Peer instance created",(t=r.value)==null?void 0:t.id),S(["Please check Peer instance",{...r.value}]),c.value=r.value.id,m.value=!0,n.value.uid=c.value,n.value.time=R().format("YYYY-MM-DD HH:mm:ss"),D.value!==null&&(D.value.srcObject=u,D.value.play(),D.value.muted=!0,f.value=!1),k.sendRequest("post",{action:"share",uid:n.value.uid,time:n.value.time,timestamp:n.value.timestamp,hook:"on-post"},()=>{T(d("webhook.postURLWebhookSuccess"))},()=>{M(d("webhook.postURLWebhookFail"))}),n.value.result="success",k.sendRequest("success",{action:"share",uid:n.value.uid,time:n.value.time,timestamp:n.value.timestamp,result:"success",hook:"on-success"},()=>{T(d("webhook.successURLWebhookSuccess"))},()=>{M(d("webhook.successURLWebhookFail"))})}catch(u){w(),ce(["sharing error",u,R().format("YYYY-MM-DD HH:mm:ss")]),u.name==="NotAllowedError"?M(d("toast.NotAllowedError")):u.toString().includes("not a function")?M(d("toast.NoMethodError")):u.toString().includes("At least one")?M(d("toast.NoSelectedError")):M(d("toast.mediaErr")),k.sendRequest("fail",{action:"share",uid:n.value.uid,time:n.value.time,timestamp:n.value.timestamp,result:"fail",hook:"on-fail"},()=>{T(d("webhook.failURLWebhookSuccess"))},()=>{M(d("webhook.failURLWebhookFail"))})}C.history.push(n.value),window.addEventListener("beforeunload",()=>{w()})}}function Z(){if(!pe())return;if(!c.value){M(d("toast.noUIDToShare"));return}let t=new URL(window.location.href).origin+"/~receive?uid="+c.value;a.autoTryPlay&&(t+="&autoplay"),fe.write(t).then(()=>{T(d("toast.copySuccess")+t)})}function ee(){w(),m.value=!1}function ae(){c.value="",a.targetUID="",x.push({query:{uid:""}})}return(t,u)=>{const i=V("VaCardTitle"),I=V("VaInput"),N=V("VaButton"),oe=V("VaCardContent"),se=V("VaCard");return p(),L("div",ge,[b(se,{class:"m-auto flex flex-col w-5/6 mb-4"},{default:q(()=>[b(i,{class:"text-lg"},{default:q(()=>[ie(K(t.$t("share.title")),1)]),_:1}),b(oe,null,{default:q(()=>[h("div",Ue,[b(I,{clearable:"",label:t.$t("share.input"),class:"grow w-24 md:w-auto",modelValue:c.value,"onUpdate:modelValue":u[0]||(u[0]=le=>c.value=le),placeholder:t.$t("share.placeholder"),onClear:ae},null,8,["label","modelValue","placeholder"]),h("div",xe,[m.value?(p(),y(N,{key:0,onClick:Z,style:{height:"34px"},round:"",class:"grow-0",icon:"share"})):(p(),y(N,{key:1,onClick:X,style:{height:"34px"},round:"",class:"grow-0",icon:"preview"}))])]),b(Se,{"show-title":!1,onChangeMediaMode:ee})]),_:1})]),_:1}),(p(),y(de,{to:"body",disabled:!l.value},[h("div",$e,[G(h("video",{class:ue(["w-5/6 m-auto shadow-md",{"video-fit-screen":l.value}]),ref_key:"screenVideo",ref:D,autoplay:"",controls:""},null,2),[[J,m.value]])])],8,["disabled"]))])}}});export{Oe as default};
